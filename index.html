<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shabu Zone Schedule Manager</title>
  
  <!-- ExcelJS for Excel export with full styling support -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <!-- ============================================ -->
  <!-- CSS STYLES - ìŠ¤íƒ€ì¼ ì •ì˜ -->
  <!-- ============================================ -->
  <style>
    /* --- ê¸°ë³¸ ë¦¬ì…‹ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* --- Body ì „ì²´ ë°°ê²½ --- */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    /* --- ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    /* --- í—¤ë” (ì œëª© + ì–¸ì–´ ì„ íƒ) --- */
    .header {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      padding: 32px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 36px; font-weight: 700; }
    .header .subtitle { font-size: 13px; opacity: 0.9; margin-top: 8px; }
    .header select {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    
    /* --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ --- */
    .tabs {
      display: flex;
      border-bottom: 2px solid #f0f0f0;
      background: #fafafa;
    }
    .tab {
      flex: 1;
      padding: 16px;
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 400;
      color: #666;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    .tab.active {
      background: white;
      border-bottom: 3px solid #667eea;
      font-weight: 600;
      color: #667eea;
    }
    
    /* --- ì½˜í…ì¸  ì˜ì—­ --- */
    .content { padding: 32px; min-height: 500px; }
    
    /* --- ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
    .btn-primary {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-secondary {
      padding: 10px 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    /* --- ë¡œë”© í™”ë©´ --- */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: white;
      font-size: 24px;
      font-weight: 600;
    }
    
    /* --- ì§ì› ê·¸ë¦¬ë“œ --- */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    
    /* --- ì§ì› ì¹´ë“œ --- */
    .employee-card {
      padding: 20px;
      background: #f9f9f9;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }
    .employee-card h3 { margin: 0 0 8px 0; font-size: 18px; font-weight: 600; }
    
    /* --- ë°°ì§€ (ì„±ë³„, ìƒíƒœ) --- */
    .badge {
      padding: 2px 8px;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 8px;
      display: inline-block;
    }
    .badge-male { background: #4D96FF; }
    .badge-female { background: #FF6B9D; }
    .badge-active { background: #4CAF50; }
    .badge-cant-work { background: #FF9800; }
    
    /* --- í¼ ê·¸ë£¹ --- */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }
    
    /* --- ëª¨ë‹¬ (íŒì—…) --- */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 32px;
      border-radius: 16px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    /* --- Requirements í…Œì´ë¸” --- */
    .requirements-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .requirements-table th,
    .requirements-table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .requirements-table th { background: #f5f5f5; font-weight: 600; }
    .requirements-table input[type="number"] {
      width: 60px;
      padding: 6px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* --- Preferences í…Œì´ë¸” --- */
    .preferences-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .preferences-table th,
    .preferences-table td {
      padding: 12px;
      border: 1px solid #e0e0e0;
    }
    .preferences-table th { background: #f5f5f5; font-weight: 600; }
    
    .pref-button {
      width: 80px;
      height: 40px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 18px;
    }
    
    /* --- Schedule ê·¸ë¦¬ë“œ --- */
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .schedule-day {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      min-height: 300px;
    }
    
    .schedule-day.holiday {
      background: #FFF3E0;
      border-color: #FF9800;
    }
    
    .schedule-day h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .schedule-shift {
      margin-bottom: 16px;
    }
    
    .schedule-shift h4 {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }
    
    .schedule-person {
      background: #f9f9f9;
      padding: 4px 8px;
      margin: 2px 0;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- ============================================ -->
  <!-- FIREBASE & JAVASCRIPT -->
  <!-- ============================================ -->
  <script type="module">
    // --- Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ Import ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ============================================
    // FIREBASE ì„¤ì •
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyBT59Rr8wwffhnPiqtnuFUl9STPvogi9TI",
      authDomain: "shabu-zone-scheduler.firebaseapp.com",
      projectId: "shabu-zone-scheduler",
      storageBucket: "shabu-zone-scheduler.firebasestorage.app",
      messagingSenderId: "306044362340",
      appId: "1:306044362340:web:94ec744da8cf51049e8971"
    };

    // --- Firebase ì´ˆê¸°í™” ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ============================================
    // STORAGE - Firebase ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
    // ============================================
    const storage = {
      // --- ë°ì´í„° ì €ì¥ ---
      async saveData(key, data) {
        try {
          await setDoc(doc(db, 'shabu-schedule', key), { data });
          console.log(`âœ… Firebase saved: ${key}`);
          return true;
        } catch (error) {
          console.error('âŒ Firebase save error:', error);
          alert(`Save error: ${error.message}`);
          return false;
        }
      },
      
      // --- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
      async loadData(key, defaultValue) {
        try {
          const docSnap = await getDoc(doc(db, 'shabu-schedule', key));
          if (docSnap.exists()) {
            console.log(`âœ… Firebase loaded: ${key}`);
            return docSnap.data().data;
          }
          return defaultValue;
        } catch (error) {
          console.error('âŒ Firebase load error:', error);
          return defaultValue;
        }
      }
    };

    // ============================================
    // ìƒìˆ˜ ì •ì˜
    // ============================================
    
    // --- ìš”ì¼ ë°°ì—´ ---
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    // --- ì‹œí”„íŠ¸ ì¢…ë¥˜ ---
    const SHIFTS = {
      morning: ['open', 'eleven', 'elevenThirty'],
      evening: ['threeThirty', 'six']
    };

    // ============================================
    // ë²ˆì—­ (3ê°œ ì–¸ì–´)
    // ============================================
    const TRANSLATIONS = {
      en: {
        appTitle: "Shabu Zone Schedule Manager",
        connectedToFirebase: "Connected to Firebase",
        tabs: {
          employees: "Employees",
          requirements: "Requirements",
          preferences: "Preferences",
          schedule: "Schedule",
          excelView: "Excel View",
          sections: "Sections"
        },
        employees: {
          title: "Employee Management",
          addEmployee: "Add Employee",
          name: "Name",
          gender: "Gender",
          male: "Male",
          female: "Female",
          status: "Status",
          active: "Active",
          cantWork: "Can't Work",
          save: "Save",
          cancel: "Cancel",
          noEmployees: "No employees yet. Click 'Add Employee' to start!",
          cantWorkDetails: "Can't Work Details",
          reason: "Reason",
          startDate: "Start Date",
          endDate: "End Date"
        },
        requirements: {
          title: "Weekly Requirements",
          copyPrevious: "Copy Previous Week",
          lunch: "LUNCH",
          dinner: "DINNER",
          open: "Open~Break",
          eleven: "11:00~Break",
          elevenThirty: "11:30~Break",
          threeThirty: "3:30~Close",
          six: "6:00~Close",
          total: "Total",
          holiday: "Holiday"
        },
        preferences: {
          title: "Employee Preferences",
          selectEmployee: "-- Select Employee --",
          minGuarantee: "Min. Guaranteed Shifts",
          savePreferences: "Save Preferences",
          lastSaved: "Last saved",
          clickToCycle: "Click to cycle colors",
          morning: "Morning",
          evening: "Evening",
          fixed: "Fixed"
        },
        schedule: {
          title: "Weekly Schedule",
          runSchedule: "Run Schedule",
          noSchedule: "No schedule generated yet. Click 'Run Schedule' to create!",
          generating: "Generating schedule...",
          lunch: "Lunch",
          dinner: "Dinner"
        },
        excelView: {
          title: "Excel View - Edit Schedule",
          noSchedule: "No schedule yet. Go to Schedule tab and click 'Run Schedule' first!",
          lunchCount: "Lunch Count",
          dinnerCount: "Dinner Count",
          allDayCount: "All Day Count",
          clickToEdit: "Click to edit shift",
          changeShift: "Change Shift",
          currentShift: "Current",
          changeTo: "Change to",
          switchEmployee: "Switch Employee",
          off: "OFF",
          availableEmployees: "Available Employees",
          swapWith: "Click to swap with"
        },
        sections: {
          title: "Section Assignment",
          comingSoon: "Coming soon!"
        }
      },
      ko: {
        appTitle: "ìƒ¤ë¶€ì¡´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬",
        connectedToFirebase: "Firebase ì—°ê²°ë¨",
        tabs: {
          employees: "ì§ì› ê´€ë¦¬",
          requirements: "ì¸ì› ì„¤ì •",
          preferences: "í¬ë§ ìŠ¤ì¼€ì¤„",
          schedule: "ìŠ¤ì¼€ì¤„",
          excelView: "ì—‘ì…€ ë·°",
          sections: "ì„¹ì…˜"
        },
        employees: {
          title: "ì§ì› ê´€ë¦¬",
          addEmployee: "ì§ì› ì¶”ê°€",
          name: "ì´ë¦„",
          gender: "ì„±ë³„",
          male: "ë‚¨ì",
          female: "ì—¬ì",
          status: "ìƒíƒœ",
          active: "ê·¼ë¬´ ê°€ëŠ¥",
          cantWork: "ê·¼ë¬´ ë¶ˆê°€",
          save: "ì €ì¥",
          cancel: "ì·¨ì†Œ",
          noEmployees: "ì•„ì§ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤. 'ì§ì› ì¶”ê°€'ë¥¼ í´ë¦­í•˜ì„¸ìš”!",
          cantWorkDetails: "ê·¼ë¬´ ë¶ˆê°€ ìƒì„¸",
          reason: "ì‚¬ìœ ",
          startDate: "ì‹œì‘ì¼",
          endDate: "ì¢…ë£Œì¼"
        },
        requirements: {
          title: "ì£¼ê°„ í•„ìš” ì¸ì›",
          copyPrevious: "ì´ì „ ì£¼ ë³µì‚¬",
          lunch: "ì ì‹¬",
          dinner: "ì €ë…",
          open: "ì˜¤í”ˆ~ë¸Œë ˆì´í¬",
          eleven: "11:00~ë¸Œë ˆì´í¬",
          elevenThirty: "11:30~ë¸Œë ˆì´í¬",
          threeThirty: "3:30~ë§ˆê°",
          six: "6:00~ë§ˆê°",
          total: "í•©ê³„",
          holiday: "íŠ¹ë³„ì¼"
        },
        preferences: {
          title: "ì§ì› í¬ë§ ìŠ¤ì¼€ì¤„",
          selectEmployee: "-- ì§ì› ì„ íƒ --",
          minGuarantee: "ìµœì†Œ ë³´ì¥ ì‹œí”„íŠ¸",
          savePreferences: "ì €ì¥",
          lastSaved: "ë§ˆì§€ë§‰ ì €ì¥",
          clickToCycle: "í´ë¦­í•˜ì—¬ ìƒ‰ìƒ ë³€ê²½",
          morning: "ì˜¤ì „",
          evening: "ì˜¤í›„",
          fixed: "ê³ ì •"
        },
        schedule: {
          title: "ì£¼ê°„ ìŠ¤ì¼€ì¤„",
          runSchedule: "ìŠ¤ì¼€ì¤„ ìƒì„±",
          noSchedule: "ì•„ì§ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤. 'ìŠ¤ì¼€ì¤„ ìƒì„±'ì„ í´ë¦­í•˜ì„¸ìš”!",
          generating: "ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘...",
          lunch: "ì ì‹¬",
          dinner: "ì €ë…"
        },
        sections: {
          title: "ì„¹ì…˜ ë°°ì •",
          comingSoon: "ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!"
        }
      },
      vi: {
        appTitle: "Quáº£n LÃ½ Lá»‹ch Shabu Zone",
        connectedToFirebase: "ÄÃ£ káº¿t ná»‘i Firebase",
        tabs: {
          employees: "NhÃ¢n ViÃªn",
          requirements: "YÃªu Cáº§u",
          preferences: "Mong Muá»‘n",
          schedule: "Lá»‹ch LÃ m",
          excelView: "Excel",
          sections: "Khu Vá»±c"
        },
        employees: {
          title: "Quáº£n LÃ½ NhÃ¢n ViÃªn",
          addEmployee: "ThÃªm NV",
          name: "TÃªn",
          gender: "Giá»›i TÃ­nh",
          male: "Nam",
          female: "Ná»¯",
          status: "Tráº¡ng ThÃ¡i",
          active: "Hoáº¡t Äá»™ng",
          cantWork: "KhÃ´ng LÃ m",
          save: "LÆ°u",
          cancel: "Há»§y",
          noEmployees: "ChÆ°a cÃ³ nhÃ¢n viÃªn. Click 'ThÃªm NV' Ä‘á»ƒ báº¯t Ä‘áº§u!",
          cantWorkDetails: "Chi Tiáº¿t KhÃ´ng LÃ m",
          reason: "LÃ½ Do",
          startDate: "NgÃ y Báº¯t Äáº§u",
          endDate: "NgÃ y Káº¿t ThÃºc"
        },
        requirements: {
          title: "YÃªu Cáº§u HÃ ng Tuáº§n",
          copyPrevious: "Sao ChÃ©p Tuáº§n TrÆ°á»›c",
          lunch: "TRÆ¯A",
          dinner: "Tá»I",
          open: "Má»Ÿ~Nghá»‰",
          eleven: "11:00~Nghá»‰",
          elevenThirty: "11:30~Nghá»‰",
          threeThirty: "3:30~ÄÃ³ng",
          six: "6:00~ÄÃ³ng",
          total: "Tá»•ng",
          holiday: "NgÃ y Lá»…"
        },
        preferences: {
          title: "Mong Muá»‘n NhÃ¢n ViÃªn",
          selectEmployee: "-- Chá»n NhÃ¢n ViÃªn --",
          minGuarantee: "Ca Tá»‘i Thiá»ƒu",
          savePreferences: "LÆ°u",
          lastSaved: "LÆ°u láº§n cuá»‘i",
          clickToCycle: "Click Ä‘á»ƒ thay Ä‘á»•i mÃ u",
          morning: "SÃ¡ng",
          evening: "Tá»‘i",
          fixed: "Cá»‘ Äá»‹nh"
        },
        schedule: {
          title: "Lá»‹ch HÃ ng Tuáº§n",
          runSchedule: "Táº¡o Lá»‹ch",
          noSchedule: "ChÆ°a cÃ³ lá»‹ch. Click 'Táº¡o Lá»‹ch' Ä‘á»ƒ báº¯t Ä‘áº§u!",
          generating: "Äang táº¡o lá»‹ch...",
          lunch: "TrÆ°a",
          dinner: "Tá»‘i"
        },
        sections: {
          title: "PhÃ¢n Khu Vá»±c",
          comingSoon: "Sáº¯p ra máº¯t!"
        }
      }
    };

    // ============================================
    // APP STATE - ì•± ì „ì²´ ìƒíƒœ ê´€ë¦¬
    // ìˆ˜ì •: ì´ˆê¸°ê°’ ë³€ê²½í•˜ë ¤ë©´ ì—¬ê¸°!
    // ============================================
    let state = {
      language: 'en',              // í˜„ì¬ ì–¸ì–´
      activeTab: 'employees',       // í˜„ì¬ íƒ­
      employees: [],                // ì§ì› ëª©ë¡
      requirements: {},             // ì£¼ê°„ í•„ìš” ì¸ì›
      preferences: {},              // ì§ì›ë³„ í¬ë§ ìŠ¤ì¼€ì¤„
      schedule: {},                 // ìƒì„±ëœ ìŠ¤ì¼€ì¤„
      loading: true,                // ë¡œë”© ìƒíƒœ
      showModal: false,             // ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€
      editingEmployee: null,        // ìˆ˜ì • ì¤‘ì¸ ì§ì›
      selectedEmployee: null,       // ì„ íƒëœ ì§ì› (Preferencesìš©)
      generating: false             // ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘
    };

    // ============================================
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    // ============================================
    async function loadInitialData() {
      state.loading = true;
      render();
      
      // --- Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
      const [employees, requirements, preferences, schedule] = await Promise.all([
        storage.loadData('employees', []),
        storage.loadData('requirements', getDefaultRequirements()),
        storage.loadData('preferences', {}),
        storage.loadData('schedule', {})
      ]);
      
      state.employees = employees;
      state.requirements = requirements;
      state.preferences = preferences;
      state.schedule = schedule;
      state.loading = false;
      
      render();
    }

    // --- ê¸°ë³¸ Requirements êµ¬ì¡° ìƒì„± ---
    function getDefaultRequirements() {
      const reqs = {};
      DAYS.forEach(day => {
        reqs[day] = {
          lunch: { open: 4, eleven: 2, elevenThirty: 3 },
          dinner: { threeThirty: 8, six: 0 },
          allDayMax: 0,
          isHoliday: false
        };
      });
      return reqs;
    }

    // ============================================
    // ë°ì´í„° ì €ì¥ í•¨ìˆ˜ë“¤
    // ============================================
    async function saveEmployees() {
      await storage.saveData('employees', state.employees);
    }

    async function saveRequirements() {
      await storage.saveData('requirements', state.requirements);
    }

    async function savePreferences() {
      await storage.saveData('preferences', state.preferences);
    }

    async function saveSchedule() {
      await storage.saveData('schedule', state.schedule);
    }

    // ============================================
    // RENDER í•¨ìˆ˜ë“¤
    // ============================================
    
    // --- ë©”ì¸ ë Œë”ë§ ---
    function render() {
      const app = document.getElementById('app');
      
      if (state.loading) {
        app.innerHTML = `<div class="loading">ğŸ”¥ Loading...</div>`;
        return;
      }

      const t = TRANSLATIONS[state.language];

      app.innerHTML = `
        <div class="container">
          ${renderHeader(t)}
          ${renderTabs(t)}
          ${renderContent(t)}
        </div>
        ${state.showModal ? renderModal(t) : ''}
      `;

      attachEventListeners();
    }

    // --- í—¤ë” ë Œë”ë§ ---
    function renderHeader(t) {
      return `
        <div class="header">
          <div>
            <h1>ğŸœ ${t.appTitle}</h1>
            <div class="subtitle">ğŸ”¥ ${t.connectedToFirebase}</div>
          </div>
          <select id="language-selector">
            <option value="en" ${state.language === 'en' ? 'selected' : ''}>ğŸ‡ºğŸ‡¸ English</option>
            <option value="ko" ${state.language === 'ko' ? 'selected' : ''}>ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
            <option value="vi" ${state.language === 'vi' ? 'selected' : ''}>ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
          </select>
        </div>
      `;
    }

    // --- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ë Œë”ë§ ---
    function renderTabs(t) {
      return `
        <div class="tabs">
          ${['employees', 'requirements', 'preferences', 'schedule', 'excelView', 'sections'].map(tab => `
            <button class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
              ${t.tabs[tab]}
            </button>
          `).join('')}
        </div>
      `;
    }

    // --- ì½˜í…ì¸  ë Œë”ë§ (íƒ­ë³„) ---
    function renderContent(t) {
      return `
        <div class="content">
          ${state.activeTab === 'employees' ? renderEmployeesTab(t) : ''}
          ${state.activeTab === 'requirements' ? renderRequirementsTab(t) : ''}
          ${state.activeTab === 'preferences' ? renderPreferencesTab(t) : ''}
          ${state.activeTab === 'schedule' ? renderScheduleTab(t) : ''}
          ${state.activeTab === 'excelView' ? renderExcelViewTab(t) : ''}
          ${state.activeTab === 'sections' ? renderSectionsTab(t) : ''}
        </div>
      `;
    }

    // ============================================
    // EMPLOYEES TAB - ì§ì› ê´€ë¦¬ íƒ­
    // ìˆ˜ì •: ì¹´ë“œ ë””ìì¸ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderEmployeesTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.employees.title} (${state.employees.length})</h2>
          <button class="btn-primary" id="add-employee-btn">
            â• ${t.employees.addEmployee}
          </button>
        </div>

        ${state.employees.length === 0 ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ‘¥</div>
            <p style="color:#999;font-size:16px;">${t.employees.noEmployees}</p>
          </div>
        ` : `
          <div class="employee-grid">
            ${state.employees.map(emp => `
              <div class="employee-card" style="${emp.status === 'cantWork' ? 'background:#FFF3E0;' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <h3>${emp.name}</h3>
                    <div style="margin:8px 0;">
                      <span class="badge ${emp.gender === 'male' ? 'badge-male' : 'badge-female'}">
                        ${emp.gender === 'male' ? t.employees.male : t.employees.female}
                      </span>
                      <span class="badge ${emp.status === 'cantWork' ? 'badge-cant-work' : 'badge-active'}">
                        ${emp.status === 'cantWork' ? t.employees.cantWork : t.employees.active}
                      </span>
                    </div>
                    ${emp.status === 'cantWork' && emp.cantWorkDetails ? `
                      <div style="font-size:12px;color:#666;margin-top:8px;padding:8px;background:white;border-radius:6px;">
                        <div><strong>${t.employees.reason}:</strong> ${emp.cantWorkDetails.reason || 'N/A'}</div>
                        <div><strong>${t.employees.startDate}:</strong> ${emp.cantWorkDetails.startDate || 'N/A'}</div>
                        <div><strong>${t.employees.endDate}:</strong> ${emp.cantWorkDetails.endDate || 'N/A'}</div>
                      </div>
                    ` : ''}
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button onclick="editEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;" title="Edit">
                      âœï¸
                    </button>
                    <button onclick="deleteEmployee(${emp.id})" style="padding:6px;background:white;border:1px solid #ddd;border-radius:6px;cursor:pointer;color:#FF6B6B;" title="Delete">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // REQUIREMENTS TAB - ì¸ì› ì„¤ì • íƒ­
    // ìˆ˜ì •: í…Œì´ë¸” êµ¬ì¡° ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderRequirementsTab(t) {
      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.requirements.title}</h2>
        </div>

        <table class="requirements-table">
          <thead>
            <tr>
              <th rowspan="2" style="width:100px;">Day</th>
              <th colspan="3">${t.requirements.lunch}</th>
              <th rowspan="2" style="width:80px;">Lunch<br>Total</th>
              <th colspan="2">${t.requirements.dinner}</th>
              <th rowspan="2" style="width:80px;">Dinner<br>Total</th>
              <th rowspan="2" style="width:80px;">All Day<br>Max</th>
              <th rowspan="2" style="width:100px;">${t.requirements.holiday}</th>
            </tr>
            <tr>
              <th>${t.requirements.open}</th>
              <th>${t.requirements.eleven}</th>
              <th>${t.requirements.elevenThirty}</th>
              <th>${t.requirements.threeThirty}</th>
              <th>${t.requirements.six}</th>
            </tr>
          </thead>
          <tbody>
            ${DAYS.map(day => {
              const req = state.requirements[day];
              const lunchTotal = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerTotal = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              return `
                <tr style="${req.isHoliday ? 'background:#FFF3E0;' : ''}">
                  <td style="font-weight:600;">${t.days?.[day] || day}</td>
                  <td><input type="number" min="0" value="${req.lunch.open}" onchange="updateRequirement('${day}', 'lunch', 'open', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.eleven}" onchange="updateRequirement('${day}', 'lunch', 'eleven', this.value)"></td>
                  <td><input type="number" min="0" value="${req.lunch.elevenThirty}" onchange="updateRequirement('${day}', 'lunch', 'elevenThirty', this.value)"></td>
                  <td style="font-weight:700;background:#E8F5E9;color:#2E7D32;font-size:16px;">${lunchTotal}</td>
                  <td><input type="number" min="0" value="${req.dinner.threeThirty}" onchange="updateRequirement('${day}', 'dinner', 'threeThirty', this.value)"></td>
                  <td><input type="number" min="0" value="${req.dinner.six}" onchange="updateRequirement('${day}', 'dinner', 'six', this.value)"></td>
                  <td style="font-weight:700;background:#E3F2FD;color:#1565C0;font-size:16px;">${dinnerTotal}</td>
                  <td><input type="number" min="0" value="${req.allDayMax || 0}" onchange="updateAllDayMax('${day}', this.value)" style="width:60px;"></td>
                  <td>
                    <input type="checkbox" ${req.isHoliday ? 'checked' : ''} onchange="toggleHoliday('${day}')" style="cursor:pointer;width:20px;height:20px;">
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>

        <div style="margin-top:20px;padding:16px;background:#E3F2FD;border-radius:8px;font-size:14px;">
          ğŸ’¡ <strong>Holiday Mode:</strong> When checked, all available employees will be scheduled regardless of preferences to prevent shortages.<br>
          <strong>Main Job employees</strong> will maintain their fixed schedule even on holidays.
        </div>
      `;
    }

    // ============================================
    // PREFERENCES TAB - í¬ë§ ìŠ¤ì¼€ì¤„ íƒ­
    // ìˆ˜ì •: ìƒ‰ìƒ ë²„íŠ¼ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderPreferencesTab(t) {
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      const selectedEmp = state.selectedEmployee;
      const empPrefs = selectedEmp ? (state.preferences[selectedEmp.id] || {}) : {};

      return `
        <div style="margin-bottom:24px;">
          <h2 style="margin:0 0 16px 0;font-size:24px;font-weight:600;">${t.preferences.title}</h2>
          
          <select id="employee-selector" style="width:300px;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
            <option value="">${t.preferences.selectEmployee}</option>
            ${activeEmployees.map(emp => `
              <option value="${emp.id}" ${selectedEmp?.id === emp.id ? 'selected' : ''}>${emp.name}</option>
            `).join('')}
          </select>
        </div>

        ${!selectedEmp ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ‘¤</div>
            <p style="color:#999;font-size:16px;">Select an employee to set preferences</p>
          </div>
        ` : `
          <div style="padding:24px;background:white;border-radius:12px;border:2px solid #667eea;">
            <h3 style="margin:0 0 16px 0;">${selectedEmp.name}</h3>
            
            <table class="preferences-table">
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="text-align:left;width:120px;">Day</th>
                  <th style="text-align:center;width:120px;">${t.preferences.morning}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                  <th style="text-align:center;width:120px;">${t.preferences.evening}</th>
                  <th style="text-align:center;width:80px;">${t.preferences.fixed}</th>
                </tr>
              </thead>
              <tbody>
                ${DAYS.map(day => {
                  const dayPrefs = empPrefs[day] || { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
                  return `
                    <tr>
                      <td style="font-weight:500;">${t.days?.[day] || day}</td>
                      <td style="text-align:center;">
                        <button class="pref-button" onclick="cyclePreference('${day}', 'morning')" 
                                style="background:${getPrefColor(dayPrefs.morning, 'morning')};">
                          ${getPrefEmoji(dayPrefs.morning, 'morning')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.morningFixed ? 'checked' : ''} 
                               onchange="toggleFixed('${day}', 'morning')"
                               style="width:20px;height:20px;cursor:pointer;"
                               ${dayPrefs.morning === 0 ? 'disabled' : ''}>
                      </td>
                      <td style="text-align:center;">
                        <button class="pref-button" onclick="cyclePreference('${day}', 'evening')" 
                                style="background:${getPrefColor(dayPrefs.evening, 'evening')};">
                          ${getPrefEmoji(dayPrefs.evening, 'evening')}
                        </button>
                      </td>
                      <td style="text-align:center;">
                        <input type="checkbox" 
                               ${dayPrefs.eveningFixed ? 'checked' : ''} 
                               onchange="toggleFixed('${day}', 'evening')"
                               style="width:20px;height:20px;cursor:pointer;"
                               ${dayPrefs.evening === 0 ? 'disabled' : ''}>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>

            <div style="margin-top:16px;padding:12px;background:#FFF3E0;border-radius:8px;font-size:13px;border-left:3px solid #F57C00;">
              <strong>â­ Fixed:</strong> When checked, this shift will <strong>ALWAYS</strong> be assigned (ignores min guarantee and shortages).<br>
              <strong>ğŸ’¡ Tip:</strong> Use Fixed for employees who need specific regular shifts (e.g., always Monday morning, always Tuesday evening).
            </div>

            <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
              ğŸ’¡ ${t.preferences.clickToCycle}<br>
              ${t.preferences.morning}: Empty â†’ ğŸŸ¡ (Open~Break) â†’ ğŸŸ¢ (11:00/11:30~Break)<br>
              ${t.preferences.evening}: Empty â†’ ğŸ”µ (3:30~Close) â†’ ğŸŸ£ (6:00~Close)
            </div>

            <div style="margin-top:24px;padding:16px;background:#f9f9f9;border-radius:8px;">
              <label style="display:block;margin-bottom:8px;font-weight:600;">
                ${t.preferences.minGuarantee}:
              </label>
              <input type="number" min="0" id="min-guarantee" value="${empPrefs.minGuarantee || 0}" 
                     style="width:100px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
              <div style="margin-top:8px;font-size:12px;color:#666;">
                (Applies only to non-fixed shifts. Fixed shifts are always assigned.)
              </div>
            </div>

            <button class="btn-primary" onclick="saveCurrentPreferences()" style="margin-top:24px;">
              ğŸ’¾ ${t.preferences.savePreferences}
            </button>

            ${empPrefs.savedAt ? `
              <div style="margin-top:12px;color:#4CAF50;font-size:14px;">
                âœ… ${t.preferences.lastSaved}: ${new Date(empPrefs.savedAt).toLocaleString()}
              </div>
            ` : ''}
          </div>
        `}
      `;
    }

    // --- Preference ìƒ‰ìƒ ë°˜í™˜ ---
    function getPrefColor(value, period) {
      if (value === 0) return '#f5f5f5';
      if (period === 'morning') return value === 1 ? '#FFD93D' : '#6BCB77';
      return value === 1 ? '#4D96FF' : '#9D4EDD';
    }

    // --- Preference ì´ëª¨ì§€ ë°˜í™˜ ---
    function getPrefEmoji(value, period) {
      if (value === 0) return 'â€”';
      if (period === 'morning') return value === 1 ? 'ğŸŸ¡' : 'ğŸŸ¢';
      return value === 1 ? 'ğŸ”µ' : 'ğŸŸ£';
    }

    // ============================================
    // SCHEDULE TAB - ìŠ¤ì¼€ì¤„ íƒ­
    // ìˆ˜ì •: ìŠ¤ì¼€ì¤„ ë ˆì´ì•„ì›ƒ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderScheduleTab(t) {
      const hasSchedule = Object.keys(state.schedule).length > 0;

      return `
        <div style="display:flex;justify-content:space-between;margin-bottom:24px;">
          <h2 style="margin:0;font-size:24px;font-weight:600;">${t.schedule.title}</h2>
          <div style="display:flex;gap:12px;">
            <button class="btn-secondary" onclick="downloadExcel()" style="display:inline-flex;align-items:center;gap:8px;">
              ğŸ“¥ Download Excel
            </button>
            <button class="btn-primary" onclick="runScheduleGeneration()" ${state.generating ? 'disabled' : ''}>
              ${state.generating ? 'â³' : 'â–¶ï¸'} ${state.generating ? t.schedule.generating : t.schedule.runSchedule}
            </button>
          </div>
        </div>

        ${!hasSchedule ? `
          <div style="padding:60px;text-align:center;background:#f9f9f9;border-radius:12px;border:2px dashed #ddd;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“…</div>
            <p style="color:#999;font-size:16px;">${t.schedule.noSchedule}</p>
          </div>
        ` : `
          <div class="schedule-grid">
            ${DAYS.map(day => {
              const daySchedule = state.schedule[day] || {};
              const isHoliday = state.requirements[day]?.isHoliday;
              const req = state.requirements[day] || { lunch: {}, dinner: {} };
              
              // í•„ìš” ì¸ì› ê³„ì‚°
              const lunchNeed = (req.lunch.open || 0) + (req.lunch.eleven || 0) + (req.lunch.elevenThirty || 0);
              const dinnerNeed = (req.dinner.threeThirty || 0) + (req.dinner.six || 0);
              
              // ë°°ì •ëœ ì¸ì›
              const lunchAssigned = (daySchedule.lunch || []).length;
              const dinnerAssigned = (daySchedule.dinner || []).length;
              
              // All Day ì§ì› ì°¾ê¸°
              const lunchNames = (daySchedule.lunch || []).map(e => e.name);
              const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
              const allDayPeople = lunchNames.filter(name => dinnerNames.includes(name));
              
              // Short/Over ì²´í¬
              const lunchDiff = lunchAssigned - lunchNeed;
              const dinnerDiff = dinnerAssigned - dinnerNeed;
              
              return `
                <div class="schedule-day ${isHoliday ? 'holiday' : ''}">
                  <h3>${t.days?.[day] || day} ${isHoliday ? 'ğŸ„' : ''}</h3>
                  
                  <!-- LUNCH SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>â˜€ï¸ ${t.schedule.lunch}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${lunchAssigned}/${lunchNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'lunch')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          ğŸ”
                        </button>
                      </div>
                    </h4>
                    
                    ${lunchDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âŒ SHORT: ${Math.abs(lunchDiff)} more needed!
                      </div>
                    ` : lunchDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âš ï¸ OVER: ${lunchDiff} extra assigned!
                      </div>
                    ` : lunchAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        âœ… OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.lunch || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'ğŸ”´ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- DINNER SECTION -->
                  <div class="schedule-shift">
                    <h4 style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                      <span>ğŸŒ™ ${t.schedule.dinner}</span>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;font-weight:normal;color:#666;">
                          ${dinnerAssigned}/${dinnerNeed}
                        </span>
                        <button onclick="showAvailable('${day}', 'dinner')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;" title="View available employees">
                          ğŸ”
                        </button>
                      </div>
                    </h4>
                    
                    ${dinnerDiff < 0 ? `
                      <div style="padding:6px 10px;background:#FFEBEE;color:#C62828;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âŒ SHORT: ${Math.abs(dinnerDiff)} more needed!
                      </div>
                    ` : dinnerDiff > 0 ? `
                      <div style="padding:6px 10px;background:#FFF3E0;color:#F57C00;border-radius:4px;margin-bottom:8px;font-size:12px;font-weight:600;">
                        âš ï¸ OVER: ${dinnerDiff} extra assigned!
                      </div>
                    ` : dinnerAssigned > 0 ? `
                      <div style="padding:4px 8px;background:#E8F5E9;color:#2E7D32;border-radius:4px;margin-bottom:8px;font-size:11px;font-weight:600;">
                        âœ… OK
                      </div>
                    ` : ''}
                    
                    ${(daySchedule.dinner || []).map(emp => {
                      const isAllDay = allDayPeople.includes(emp.name);
                      const fixedMark = emp.isFixed ? ' *' : '';
                      return `
                        <div class="schedule-person" style="${isAllDay ? 'font-weight:700;border-left:3px solid #D32F2F;' : ''}">
                          ${isAllDay ? 'ğŸ”´ ' : ''}${emp.name}${fixedMark} <span style="font-size:11px;color:#666;">(${emp.shift})</span>
                        </div>
                      `;
                    }).join('') || '<div style="color:#999;font-size:12px;padding:8px;">No assignments</div>'}
                  </div>

                  <!-- ALL DAY SUMMARY -->
                  ${allDayPeople.length > 0 ? `
                    <div style="margin-top:12px;padding:8px;background:${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#FFEBEE' 
                        : '#FFF3E0'
                    };border-radius:6px;border-left:3px solid ${
                      req.allDayMax && allDayPeople.length > req.allDayMax 
                        ? '#C62828' 
                        : '#F57C00'
                    };">
                      <div style="font-size:11px;font-weight:600;color:${
                        req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? '#C62828' 
                          : '#E65100'
                      };margin-bottom:4px;">
                        ğŸ“Š All Day: ${allDayPeople.length}${req.allDayMax ? `/${req.allDayMax}` : ''} 
                        ${req.allDayMax && allDayPeople.length > req.allDayMax 
                          ? `âš ï¸ (${allDayPeople.length - req.allDayMax} over - remove some Fixed)` 
                          : ''}
                      </div>
                      <div style="font-size:11px;color:#666;">
                        ${allDayPeople.join(', ')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `}
      `;
    }

    // ============================================
    // ============================================
    // EXCEL VIEW TAB - ì—‘ì…€ ë·° íƒ­
    // ============================================
    function renderExcelViewTab(t) {
      if (!state.schedule || Object.keys(state.schedule).length === 0) {
        return `
          <div style="padding:60px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“Š</div>
            <h3>${t.excelView.noSchedule}</h3>
          </div>
        `;
      }

      // ì •í•´ì§„ ì§ì› ìˆœì„œ
      const employeeOrder = [
        'Aiden', 'Carlos', 'Edgar', 'Hung', 'Thanh', 'Tien', 'Tommy', 'Judy', 
        'Justin', 'Tina N', 'Alan', 'Chau', 'Le', 'Crystal', 'Tue', 'Cherry', 
        'Christine', 'Hieu', 'Kai', 'Dat', 'Johnny', 'Ly', 'Tho', 'Kha', 
        'Phung', 'Ye', 'Esther', 'Duc', 'Jimmy', 'Aca', 'Vivi', 'Catherine', 
        'Tiffany', 'Steven', 'Chris', 'Dung'
      ];

      // í™œì„± ì§ì› ì •ë ¬
      const orderedEmployees = [];
      employeeOrder.forEach(name => {
        const emp = state.employees.find(e => e.name === name && e.status === 'active');
        if (emp) orderedEmployees.push(emp);
      });

      // ìˆœì„œì— ì—†ëŠ” ì§ì› ì¶”ê°€
      state.employees.filter(e => e.status === 'active').forEach(emp => {
        if (!employeeOrder.includes(emp.name)) {
          orderedEmployees.push(emp);
        }
      });

      return `
        <div>
          <h2 style="margin:0 0 16px 0;font-size:24px;font-weight:600;">${t.excelView.title}</h2>
          
          <div style="overflow-x:auto;max-height:calc(100vh - 200px);border:3px solid #333;border-radius:8px;">
            <table style="width:100%;border-collapse:collapse;background:white;font-size:13px;">
              <thead style="position:sticky;top:0;z-index:10;">
                <tr style="background:#667eea;color:white;">
                  <th style="padding:10px;border:2px solid #333;width:35px;position:sticky;left:0;background:#667eea;z-index:11;">#</th>
                  <th style="padding:10px;border:2px solid #333;width:90px;position:sticky;left:35px;background:#667eea;z-index:11;">Name</th>
                  ${DAYS.map(day => {
                    const dayT = TRANSLATIONS[state.language];
                    return `
                      <th style="padding:10px;border:2px solid #333;min-width:110px;">
                        ${dayT.days?.[day] || day}
                      </th>
                    `;
                  }).join('')}
                </tr>
              </thead>
              <tbody>
                ${orderedEmployees.map((emp, idx) => {
                  return `
                    <!-- Lunch Row -->
                    <tr>
                      <td rowspan="2" style="padding:8px;border:2px solid #333;text-align:center;background:#f0f0f0;font-weight:700;position:sticky;left:0;z-index:5;">${idx + 1}</td>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#FFF9E6;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Lunch</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'lunch')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(lunchShift?.shift)};
                                     ${lunchShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${lunchShift ? lunchShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                    <!-- Dinner Row -->
                    <tr>
                      <td style="padding:8px;border:2px solid #333;font-weight:600;background:#E6F3FF;position:sticky;left:35px;z-index:5;">
                        ${emp.name}
                        <div style="font-size:10px;color:#666;font-weight:400;">Dinner</div>
                      </td>
                      ${DAYS.map(day => {
                        const daySchedule = state.schedule[day] || {};
                        const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);
                        
                        return `
                          <td onclick="editShift('${emp.id}', '${day}', 'dinner')" 
                              style="padding:8px;border:2px solid #333;cursor:pointer;text-align:center;
                                     background:${getShiftColor(dinnerShift?.shift)};
                                     ${dinnerShift ? 'font-weight:600;' : ''}
                                     transition:background 0.2s;">
                            ${dinnerShift ? dinnerShift.shift : ''}
                          </td>
                        `;
                      }).join('')}
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot style="position:sticky;bottom:0;background:white;z-index:8;">
                <tr style="background:#E8F5E9;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E8F5E9;z-index:9;">
                    Lunch:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchCount = (daySchedule.lunch || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#2E7D32;">${lunchCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#E3F2FD;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#E3F2FD;z-index:9;">
                    Dinner:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const dinnerCount = (daySchedule.dinner || []).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#1565C0;">${dinnerCount}</td>
                    `;
                  }).join('')}
                </tr>
                <tr style="background:#FFF3E0;font-weight:700;font-size:12px;">
                  <td colspan="2" style="padding:10px;border:2px solid #333;text-align:right;position:sticky;left:0;background:#FFF3E0;z-index:9;">
                    All Day:
                  </td>
                  ${DAYS.map(day => {
                    const daySchedule = state.schedule[day] || {};
                    const lunchNames = (daySchedule.lunch || []).map(e => e.name);
                    const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
                    const allDayCount = lunchNames.filter(name => dinnerNames.includes(name)).length;
                    return `
                      <td style="padding:10px;border:2px solid #333;text-align:center;color:#F57C00;">${allDayCount}</td>
                    `;
                  }).join('')}
                </tr>
              </tfoot>
            </table>
          </div>

          <div style="margin-top:16px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
            ğŸ’¡ <strong>Tip:</strong> Click any cell to edit shift. Use arrow keys or scroll to navigate.
          </div>
        </div>
      `;
    }

    // ì‹œí”„íŠ¸ ìƒ‰ìƒ ë°˜í™˜
    function getShiftColor(shift) {
      if (!shift) return '#ffffff';
      if (shift.includes('Open')) return '#FFD93D';  // ğŸŸ¡ ë…¸ë€ìƒ‰
      if (shift.includes('11:00') || shift.includes('11:30')) return '#6BCB77';  // ğŸŸ¢ ì´ˆë¡ìƒ‰
      if (shift.includes('3:30')) return '#4D96FF';  // ğŸ”µ íŒŒë€ìƒ‰
      if (shift.includes('6:00') || shift.includes('6 PM')) return '#9D4EDD';  // ğŸŸ£ ë³´ë¼ìƒ‰
      return '#ffffff';
    }

    // SECTIONS TAB - ì„¹ì…˜ íƒ­
    // ============================================
    function renderSectionsTab(t) {
      return `
        <div style="padding:60px;text-align:center;">
          <div style="font-size:48px;margin-bottom:16px;">ğŸ—ï¸</div>
          <h2 style="color:#999;margin-bottom:8px;">${t.sections.title}</h2>
          <p style="color:#999;">${t.sections.comingSoon}</p>
        </div>
      `;
    }

    // ============================================
    // MODAL - ì§ì› ì¶”ê°€/ìˆ˜ì • íŒì—…
    // ìˆ˜ì •: ëª¨ë‹¬ ë””ìì¸ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    function renderModal(t) {
      const currentStatus = state.editingEmployee?.status || 'active';
      const cantWorkDetails = state.editingEmployee?.cantWorkDetails || {};
      
      return `
        <div class="modal show" onclick="if(event.target === this) closeModal()">
          <div class="modal-content">
            <h3 style="margin-top:0;">${state.editingEmployee ? 'Edit Employee' : t.employees.addEmployee}</h3>
            <form id="employee-form">
              <div class="form-group">
                <label>${t.employees.name} *</label>
                <input type="text" id="emp-name" required value="${state.editingEmployee?.name || ''}" autocomplete="off">
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.gender}</label>
                  <select id="emp-gender">
                    <option value="male" ${state.editingEmployee?.gender === 'male' ? 'selected' : ''}>${t.employees.male}</option>
                    <option value="female" ${state.editingEmployee?.gender === 'female' ? 'selected' : ''}>${t.employees.female}</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.status}</label>
                  <select id="emp-status">
                    <option value="active" ${currentStatus === 'active' ? 'selected' : ''}>${t.employees.active}</option>
                    <option value="cantWork" ${currentStatus === 'cantWork' ? 'selected' : ''}>${t.employees.cantWork}</option>
                  </select>
                </div>
              </div>

              <div id="cant-work-details" style="display:${currentStatus === 'cantWork' ? 'block' : 'none'};padding:16px;background:#FFF3E0;border-radius:8px;margin-bottom:16px;">
                <h4 style="margin:0 0 12px 0;font-size:14px;font-weight:600;">${t.employees.cantWorkDetails}</h4>
                
                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.reason}</label>
                  <select id="cant-work-reason">
                    <option value="Vacation" ${cantWorkDetails.reason === 'Vacation' ? 'selected' : ''}>Vacation</option>
                    <option value="Sick" ${cantWorkDetails.reason === 'Sick' ? 'selected' : ''}>Sick</option>
                    <option value="Out of Town" ${cantWorkDetails.reason === 'Out of Town' ? 'selected' : ''}>Out of Town</option>
                    <option value="Other" ${cantWorkDetails.reason === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>

                <div class="form-group" style="margin-bottom:12px;">
                  <label>${t.employees.startDate}</label>
                  <input type="date" id="cant-work-start" value="${cantWorkDetails.startDate || ''}">
                </div>

                <div class="form-group" style="margin-bottom:0;">
                  <label>${t.employees.endDate}</label>
                  <input type="date" id="cant-work-end" value="${cantWorkDetails.endDate || ''}">
                </div>
              </div>

              <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                <button type="button" class="btn-secondary" onclick="closeModal()">
                  ${t.employees.cancel}
                </button>
                <button type="submit" class="btn-primary">
                  ${t.employees.save}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    // ============================================
    // EVENT LISTENERS - ì´ë²¤íŠ¸ ì²˜ë¦¬
    // ============================================
    function attachEventListeners() {
      // --- ì–¸ì–´ ì„ íƒ ---
      const langSelector = document.getElementById('language-selector');
      if (langSelector) {
        langSelector.addEventListener('change', (e) => {
          state.language = e.target.value;
          render();
        });
      }

      // --- íƒ­ ì „í™˜ ---
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          state.activeTab = e.target.dataset.tab;
          render();
        });
      });

      // --- ì§ì› ì¶”ê°€ ë²„íŠ¼ ---
      const addBtn = document.getElementById('add-employee-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          state.editingEmployee = null;
          state.showModal = true;
          render();
        });
      }

      // --- Status ë³€ê²½ ì‹œ Can't Work í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ---
      const statusSelect = document.getElementById('emp-status');
      if (statusSelect) {
        statusSelect.addEventListener('change', (e) => {
          const cantWorkDetails = document.getElementById('cant-work-details');
          if (cantWorkDetails) {
            cantWorkDetails.style.display = e.target.value === 'cantWork' ? 'block' : 'none';
          }
        });
      }

      // --- ì§ì› í¼ ì œì¶œ ---
      const form = document.getElementById('employee-form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const status = document.getElementById('emp-status').value;
          const empData = {
            id: state.editingEmployee?.id || Date.now(),
            name: document.getElementById('emp-name').value.trim(),
            gender: document.getElementById('emp-gender').value,
            status: status,
            availableSections: {
              'A-F': true,
              'G+Room': true,
              'H-L': true,
              'Helper': false,
              'MH': false,
              'FR': false
            },
            conflictWith: []
          };

          if (status === 'cantWork') {
            empData.cantWorkDetails = {
              reason: document.getElementById('cant-work-reason').value,
              startDate: document.getElementById('cant-work-start').value,
              endDate: document.getElementById('cant-work-end').value
            };
          }

          if (state.editingEmployee) {
            state.employees = state.employees.map(e => 
              e.id === empData.id ? empData : e
            );
          } else {
            state.employees.push(empData);
          }

          await saveEmployees();
          state.showModal = false;
          render();
        });
      }

      // --- Preferences ì§ì› ì„ íƒ ---
      const empSelector = document.getElementById('employee-selector');
      if (empSelector) {
        empSelector.addEventListener('change', (e) => {
          const empId = parseInt(e.target.value);
          state.selectedEmployee = state.employees.find(emp => emp.id === empId);
          render();
        });
      }
    }

    // ============================================
    // GLOBAL FUNCTIONS - onclickì—ì„œ í˜¸ì¶œ
    // ============================================
    
    // --- ì§ì› ìˆ˜ì • ---
    window.editEmployee = (id) => {
      state.editingEmployee = state.employees.find(e => e.id === id);
      state.showModal = true;
      render();
    };

    // --- ì§ì› ì‚­ì œ ---
    window.deleteEmployee = (id) => {
      if (confirm('Delete this employee?')) {
        state.employees = state.employees.filter(e => e.id !== id);
        saveEmployees();
        render();
      }
    };

    // --- ê°€ëŠ¥í•œ ì§ì› ë³´ê¸° (ë‹ë³´ê¸° ë²„íŠ¼) ---
    window.showAvailable = (day, period) => {
      const daySchedule = state.schedule[day] || {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');
      
      // ì´ë¯¸ ë°°ì •ëœ ì§ì› ID
      const assignedIds = [
        ...(daySchedule.lunch || []).map(e => e.id),
        ...(daySchedule.dinner || []).map(e => e.id)
      ];
      
      // ë°°ì • ì•ˆ ëœ ì§ì›ë“¤
      const availableEmployees = activeEmployees.filter(emp => 
        !assignedIds.includes(emp.id)
      );
      
      // Preference ì •ë³´ í¬í•¨
      const employeesWithPrefs = availableEmployees.map(emp => {
        const prefs = state.preferences[emp.id]?.[day];
        let prefText = 'No preference';
        let prefColor = '#999';
        
        if (period === 'lunch' && prefs?.morning) {
          if (prefs.morning === 1) {
            prefText = 'ğŸŸ¡ Prefers Open';
            prefColor = '#FFD93D';
          } else if (prefs.morning === 2) {
            prefText = 'ğŸŸ¢ Prefers 11:00/11:30';
            prefColor = '#6BCB77';
          }
        } else if (period === 'dinner' && prefs?.evening) {
          if (prefs.evening === 1) {
            prefText = 'ğŸ”µ Prefers 3:30';
            prefColor = '#4D96FF';
          } else if (prefs.evening === 2) {
            prefText = 'ğŸŸ£ Prefers 6:00';
            prefColor = '#9D4EDD';
          }
        }
        
        return { emp, prefText, prefColor };
      });
      
      // ëª¨ë‹¬ ìƒì„±
      const t = TRANSLATIONS[state.language];
      const periodName = period === 'lunch' ? t.schedule.lunch : t.schedule.dinner;
      const dayName = t.days?.[day] || day;
      
      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeAvailableModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">ğŸ” Available for ${dayName} ${periodName}</h3>
              <button onclick="closeAvailableModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>
            
            ${employeesWithPrefs.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <div style="font-size:48px;margin-bottom:16px;">âœ…</div>
                <p style="color:#666;font-size:16px;">All active employees are already assigned!</p>
              </div>
            ` : `
              <div style="max-height:400px;overflow-y:auto;">
                ${employeesWithPrefs.map(({ emp, prefText, prefColor }) => `
                  <div style="padding:12px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;border-left:4px solid ${prefColor};">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${emp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              
              <div style="margin-top:20px;padding:12px;background:#E3F2FD;border-radius:8px;font-size:13px;">
                ğŸ’¡ <strong>Tip:</strong> These employees are not currently assigned to any shift on ${dayName}.
              </div>
            `}
          </div>
        </div>
      `;
      
      // ëª¨ë‹¬ í‘œì‹œ
      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };
    
    // --- Excel ë‹¤ìš´ë¡œë“œ (ExcelJS - ìƒ‰ìƒ ì§€ì›!) ---
    window.downloadExcel = async () => {
    if (!state.schedule || Object.keys(state.schedule).length === 0) {
    alert('âš ï¸ No schedule generated yet!');
    return;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Schedule');

    const employeeOrder = [
    'Aiden', 'Carlos', 'Edgar', 'Hung', 'Thanh', 'Tien', 'Tommy', 'Judy', 
    'Justin', 'Tina N', 'Alan', 'Chau', 'Le', 'Crystal', 'Tue', 'Cherry', 
    'Christine', 'Hieu', 'Kai', 'Dat', 'Johnny', 'Ly', 'Tho', 'Kha', 
    'Phung', 'Ye', 'Esther', 'Duc', 'Jimmy', 'Aca', 'Vivi', 'Catherine', 
    'Tiffany', 'Steven', 'Chris', 'Dung'
    ];

    const orderedEmployees = [];
    employeeOrder.forEach(name => {
    const emp = state.employees.find(e => e.name === name && e.status === 'active');
    if (emp) orderedEmployees.push(emp);
    });

    // ì—´ ë„ˆë¹„
    const columns = [{ width: 5 }, { width: 12 }];
    DAYS.forEach(() => {
    columns.push({ width: 14 });
    columns.push({ width: 14 });
    });
    worksheet.columns = columns;

    // Row 1: Schedule ì œëª©
    const totalCols = 2 + DAYS.length * 2;
    const lastCol = String.fromCharCode(65 + totalCols - 1);
    worksheet.mergeCells(`A1:${lastCol}1`);
    const titleCell = worksheet.getCell('A1');
    titleCell.value = 'Schedule';
    titleCell.font = { bold: true, size: 16, color: { argb: 'FFFFFFFF' } };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667eea' } };

    // Row 2: ìš”ì¼
    const dayHeaderRow = worksheet.getRow(2);
    dayHeaderRow.values = ['', 'Name', ...DAYS.flatMap(day => [day, ''])];
    
    let colIndex = 3;
    DAYS.forEach(() => {
    const col1 = String.fromCharCode(64 + colIndex);
    const col2 = String.fromCharCode(64 + colIndex + 1);
    worksheet.mergeCells(`${col1}2:${col2}2`);
    colIndex += 2;
    });

    dayHeaderRow.eachCell((cell) => {
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667eea' } };
    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
    cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });

    // Row 3: Lunch/Dinner
    const shiftHeaderRow = worksheet.getRow(3);
    shiftHeaderRow.values = ['', '', ...DAYS.flatMap(() => ['Lunch', 'Dinner'])];
    shiftHeaderRow.eachCell((cell) => {
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF9D4EDD' } };
    cell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 10 };
    cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });

    let currentRow = 4;

    // ì§ì› ë°ì´í„°
    orderedEmployees.forEach((emp, idx) => {
    const empRow = worksheet.getRow(currentRow);
    const rowData = [idx + 1, emp.name];
    
    DAYS.forEach(day => {
      const daySchedule = state.schedule[day] || {};
      const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
      const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);
      rowData.push(lunchShift ? lunchShift.shift : '');
      rowData.push(dinnerShift ? dinnerShift.shift : '');
    });
    
    empRow.values = rowData;

    // ìŠ¤íƒ€ì¼
    empRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
    empRow.getCell(1).font = { bold: true };
    empRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };

    empRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9F9F9' } };
    empRow.getCell(2).font = { bold: true };
    empRow.getCell(2).alignment = { horizontal: 'left', vertical: 'middle' };

    let cellIdx = 3;
    DAYS.forEach(day => {
      const daySchedule = state.schedule[day] || {};
      const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
      const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);

      const lunchCell = empRow.getCell(cellIdx);
      if (lunchShift) {
        lunchCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: getShiftColorARGB(lunchShift.shift) } };
        lunchCell.font = { bold: true, size: 9 };
      }
      lunchCell.alignment = { horizontal: 'center', vertical: 'middle' };
      cellIdx++;

      const dinnerCell = empRow.getCell(cellIdx);
      if (dinnerShift) {
        dinnerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: getShiftColorARGB(dinnerShift.shift) } };
        dinnerCell.font = { bold: true, size: 9 };
      }
      dinnerCell.alignment = { horizontal: 'center', vertical: 'middle' };
      cellIdx++;
    });

    currentRow++;
    });

    // Counts
    currentRow++;
    
    const lunchCountRow = worksheet.getRow(currentRow);
    lunchCountRow.getCell(2).value = 'Lunch Count:';
    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    lunchCountRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
    lunchCountRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
    
    let cellIdx = 3;
    DAYS.forEach(day => {
    const daySchedule = state.schedule[day] || {};
    const lunchCell = lunchCountRow.getCell(cellIdx);
    lunchCell.value = (daySchedule.lunch || []).length;
    lunchCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
    lunchCell.font = { bold: true, color: { argb: 'FF2E7D32' } };
    lunchCell.alignment = { horizontal: 'center', vertical: 'middle' };
    
    cellIdx += 2;
    });

    currentRow++;
    
    const dinnerCountRow = worksheet.getRow(currentRow);
    dinnerCountRow.getCell(2).value = 'Dinner Count:';
    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    dinnerCountRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
    dinnerCountRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
    
    cellIdx = 4;
    DAYS.forEach(day => {
    const daySchedule = state.schedule[day] || {};
    const dinnerCell = dinnerCountRow.getCell(cellIdx);
    dinnerCell.value = (daySchedule.dinner || []).length;
    dinnerCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
    dinnerCell.font = { bold: true, color: { argb: 'FF1565C0' } };
    dinnerCell.alignment = { horizontal: 'center', vertical: 'middle' };
    
    cellIdx += 2;
    });

    currentRow++;
    
    const allDayCountRow = worksheet.getRow(currentRow);
    allDayCountRow.getCell(2).value = 'All Day Count:';
    worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
    allDayCountRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3E0' } };
    allDayCountRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
    
    cellIdx = 3;
    DAYS.forEach(day => {
    const daySchedule = state.schedule[day] || {};
    const lunchNames = (daySchedule.lunch || []).map(e => e.name);
    const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
    const allDayCount = lunchNames.filter(name => dinnerNames.includes(name)).length;
    
    worksheet.mergeCells(`${String.fromCharCode(64 + cellIdx)}${currentRow}:${String.fromCharCode(64 + cellIdx + 1)}${currentRow}`);
    const allDayCell = allDayCountRow.getCell(cellIdx);
    allDayCell.value = allDayCount;
    allDayCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3E0' } };
    allDayCell.font = { bold: true, color: { argb: 'FFF57C00' } };
    allDayCell.alignment = { horizontal: 'center', vertical: 'middle' };
    
    cellIdx += 2;
    });

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const today = new Date().toISOString().split('T')[0];
    saveAs(blob, `Shabu_Zone_Schedule_${today}.xlsx`);
    
    alert('âœ… Excel downloaded with colors!');
};



      titleCell.font = { bold: true, size: 16, color: { argb: 'FFFFFFFF' } };

      // Row 2: í—¤ë” (# | Name | Days)
      const headerRow = worksheet.getRow(2);
      headerRow.values = ['#', 'Name', ...DAYS];
      headerRow.height = 25;
      headerRow.eachCell((cell) => {
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF667eea' }
        };
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
          top: { style: 'thick', color: { argb: 'FF000000' } },
          left: { style: 'thick', color: { argb: 'FF000000' } },
          bottom: { style: 'thick', color: { argb: 'FF000000' } },
          right: { style: 'thick', color: { argb: 'FF000000' } }
        };
      });

      let currentRow = 3;

      // ì§ì› ë°ì´í„°
      orderedEmployees.forEach((emp, idx) => {
        // Lunch Row
        const lunchRow = worksheet.getRow(currentRow);
        lunchRow.height = 20;
        lunchRow.getCell(1).value = idx + 1;
        lunchRow.getCell(2).value = emp.name + '\nLunch';

        // ë²ˆí˜¸ì™€ ì´ë¦„ ë³‘í•© (Lunch + Dinner)
        worksheet.mergeCells(`A${currentRow}:A${currentRow + 1}`);
        worksheet.mergeCells(`B${currentRow}:B${currentRow + 1}`);

        // ë²ˆí˜¸ ì…€ ìŠ¤íƒ€ì¼
        const numCell = lunchRow.getCell(1);
        numCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFF0F0F0' }
        };
        numCell.font = { bold: true, size: 11 };
        numCell.alignment = { horizontal: 'center', vertical: 'middle' };
        numCell.border = {
          top: { style: 'thick' },
          left: { style: 'thick' },
          bottom: { style: 'thick' },
          right: { style: 'thick' }
        };

        // ì´ë¦„ ì…€ ìŠ¤íƒ€ì¼
        const nameCell = lunchRow.getCell(2);
        nameCell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFF9F9F9' }
        };
        nameCell.font = { bold: true, size: 11 };
        nameCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
        nameCell.border = {
          top: { style: 'thick' },
          left: { style: 'thick' },
          bottom: { style: 'thick' },
          right: { style: 'thick' }
        };

        // Lunch ì‹œí”„íŠ¸
        DAYS.forEach((day, dayIdx) => {
          const daySchedule = state.schedule[day] || {};
          const lunchShift = (daySchedule.lunch || []).find(e => e.id === emp.id);
          const cell = lunchRow.getCell(3 + dayIdx);
          cell.value = lunchShift ? lunchShift.shift : '';
          
          if (lunchShift) {
            const bgColor = getShiftColorARGB(lunchShift.shift);
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: bgColor }
            };
            cell.font = { bold: true, size: 10 };
          }
          
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = {
            top: { style: 'thick' },
            left: { style: 'thick' },
            bottom: { style: 'medium' },
            right: { style: 'thick' }
          };
        });

        currentRow++;

        // Dinner Row
        const dinnerRow = worksheet.getRow(currentRow);
        dinnerRow.height = 20;

        DAYS.forEach((day, dayIdx) => {
          const daySchedule = state.schedule[day] || {};
          const dinnerShift = (daySchedule.dinner || []).find(e => e.id === emp.id);
          const cell = dinnerRow.getCell(3 + dayIdx);
          cell.value = dinnerShift ? dinnerShift.shift : '';
          
          if (dinnerShift) {
            const bgColor = getShiftColorARGB(dinnerShift.shift);
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: bgColor }
            };
            cell.font = { bold: true, size: 10 };
          }
          
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = {
            top: { style: 'medium' },
            left: { style: 'thick' },
            bottom: { style: 'thick' },
            right: { style: 'thick' }
          };
        });

        currentRow++;
      });

      // ë¹ˆ ì¤„
      currentRow++;

      // Lunch Count
      const lunchCountRow = worksheet.getRow(currentRow);
      lunchCountRow.getCell(1).value = '';
      lunchCountRow.getCell(2).value = 'Lunch Count:';
      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
      
      const lunchLabelCell = lunchCountRow.getCell(1);
      lunchLabelCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFE8F5E9' }
      };
      lunchLabelCell.font = { bold: true, size: 11 };
      lunchLabelCell.alignment = { horizontal: 'right', vertical: 'middle' };
      lunchLabelCell.border = {
        top: { style: 'thick' },
        left: { style: 'thick' },
        bottom: { style: 'thick' },
        right: { style: 'thick' }
      };

      DAYS.forEach((day, dayIdx) => {
        const daySchedule = state.schedule[day] || {};
        const lunchCount = (daySchedule.lunch || []).length;
        const cell = lunchCountRow.getCell(3 + dayIdx);
        cell.value = lunchCount;
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFE8F5E9' }
        };
        cell.font = { bold: true, size: 11, color: { argb: 'FF2E7D32' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
          top: { style: 'thick' },
          left: { style: 'thick' },
          bottom: { style: 'thick' },
          right: { style: 'thick' }
        };
      });

      currentRow++;

      // Dinner Count
      const dinnerCountRow = worksheet.getRow(currentRow);
      dinnerCountRow.getCell(1).value = '';
      dinnerCountRow.getCell(2).value = 'Dinner Count:';
      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
      
      const dinnerLabelCell = dinnerCountRow.getCell(1);
      dinnerLabelCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFE3F2FD' }
      };
      dinnerLabelCell.font = { bold: true, size: 11 };
      dinnerLabelCell.alignment = { horizontal: 'right', vertical: 'middle' };
      dinnerLabelCell.border = {
        top: { style: 'thick' },
        left: { style: 'thick' },
        bottom: { style: 'thick' },
        right: { style: 'thick' }
      };

      DAYS.forEach((day, dayIdx) => {
        const daySchedule = state.schedule[day] || {};
        const dinnerCount = (daySchedule.dinner || []).length;
        const cell = dinnerCountRow.getCell(3 + dayIdx);
        cell.value = dinnerCount;
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFE3F2FD' }
        };
        cell.font = { bold: true, size: 11, color: { argb: 'FF1565C0' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
          top: { style: 'thick' },
          left: { style: 'thick' },
          bottom: { style: 'thick' },
          right: { style: 'thick' }
        };
      });

      currentRow++;

      // All Day Count
      const allDayCountRow = worksheet.getRow(currentRow);
      allDayCountRow.getCell(1).value = '';
      allDayCountRow.getCell(2).value = 'All Day Count:';
      worksheet.mergeCells(`A${currentRow}:B${currentRow}`);
      
      const allDayLabelCell = allDayCountRow.getCell(1);
      allDayLabelCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFF3E0' }
      };
      allDayLabelCell.font = { bold: true, size: 11 };
      allDayLabelCell.alignment = { horizontal: 'right', vertical: 'middle' };
      allDayLabelCell.border = {
        top: { style: 'thick' },
        left: { style: 'thick' },
        bottom: { style: 'thick' },
        right: { style: 'thick' }
      };

      DAYS.forEach((day, dayIdx) => {
        const daySchedule = state.schedule[day] || {};
        const lunchNames = (daySchedule.lunch || []).map(e => e.name);
        const dinnerNames = (daySchedule.dinner || []).map(e => e.name);
        const allDayCount = lunchNames.filter(name => dinnerNames.includes(name)).length;
        const cell = allDayCountRow.getCell(3 + dayIdx);
        cell.value = allDayCount;
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFF3E0' }
        };
        cell.font = { bold: true, size: 11, color: { argb: 'FFF57C00' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
          top: { style: 'thick' },
          left: { style: 'thick' },
          bottom: { style: 'thick' },
          right: { style: 'thick' }
        };
      });

      // íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const today = new Date().toISOString().split('T')[0];
      saveAs(blob, `Shabu_Zone_Schedule_${today}.xlsx`);
      
      alert('âœ… Excel file downloaded with full colors and styling!');
    };

    // ì‹œí”„íŠ¸ ìƒ‰ìƒ ARGB ë°˜í™˜ (ExcelJSìš©)
    function getShiftColorARGB(shift) {
      if (!shift) return 'FFFFFFFF';
      if (shift.includes('Open')) return 'FFFFD93D';  // ğŸŸ¡ ë…¸ë€ìƒ‰
      if (shift.includes('11:00') || shift.includes('11:30')) return 'FF6BCB77';  // ğŸŸ¢ ì´ˆë¡ìƒ‰
      if (shift.includes('3:30')) return 'FF4D96FF';  // ğŸ”µ íŒŒë€ìƒ‰
      if (shift.includes('6:00') || shift.includes('6 PM')) return 'FF9D4EDD';  // ğŸŸ£ ë³´ë¼ìƒ‰
      return 'FFFFFFFF';
    }

    // --- ì‹œí”„íŠ¸ í¸ì§‘ (Excel View) ---
    window.editShift = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const currentShift = period === 'lunch' 
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      // ê°€ëŠ¥í•œ ì‹œí”„íŠ¸ ì˜µì…˜
      const shiftOptions = period === 'lunch' 
        ? ['Open~Break', '11:00~Break', '11:30~Break']
        : ['3:30~Close', '6:00~Close'];

      const modalHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:500px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">${dayName} ${periodName} - ${emp.name}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>

            ${currentShift ? `
              <div style="padding:12px;background:#E3F2FD;border-radius:8px;margin-bottom:20px;">
                <strong>Current:</strong> 
                <span style="padding:4px 12px;background:${getShiftColor(currentShift.shift)};border-radius:6px;display:inline-block;margin-left:8px;">
                  ${currentShift.shift}
                </span>
              </div>
            ` : `
              <div style="padding:12px;background:#FFF3E0;border-radius:8px;margin-bottom:20px;">
                <strong>Currently:</strong> OFF
              </div>
            `}

            <div style="margin-bottom:20px;">
              <h4 style="margin:0 0 12px 0;">Change to:</h4>
              ${shiftOptions.map(shift => `
                <button onclick="changeShift(${empId}, '${day}', '${period}', '${shift}')" 
                        style="display:block;width:100%;padding:12px;margin-bottom:8px;
                               background:${getShiftColor(shift)};border:2px solid #333;
                               border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;
                               ${currentShift?.shift === shift ? 'opacity:0.5;' : ''}">
                  ${shift}
                </button>
              `).join('')}
              <button onclick="changeShift(${empId}, '${day}', '${period}', '')" 
                      style="display:block;width:100%;padding:12px;background:white;
                             border:2px solid #ddd;border-radius:8px;cursor:pointer;
                             font-weight:600;color:#666;">
                OFF (Remove shift)
              </button>
            </div>

            <button onclick="showSwapOptions(${empId}, '${day}', '${period}')" 
                    class="btn-secondary" style="width:100%;padding:14px;font-size:15px;">
              ğŸ”„ Switch Employee
            </button>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    };

    // --- ì‹œí”„íŠ¸ ë³€ê²½ ---
    window.changeShift = async (empId, day, period, newShift) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];
      const existingIndex = shifts.findIndex(e => e.id === emp.id);

      if (newShift === '') {
        // Remove shift
        if (existingIndex !== -1) {
          shifts.splice(existingIndex, 1);
        }
      } else {
        // Add or update shift
        const shiftData = {
          name: emp.name,
          shift: newShift,
          id: emp.id,
          isFixed: false
        };

        if (existingIndex !== -1) {
          shifts[existingIndex] = shiftData;
        } else {
          shifts.push(shiftData);
        }
      }

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- Switch ì˜µì…˜ í‘œì‹œ ---
    window.showSwapOptions = (empId, day, period) => {
      const emp = state.employees.find(e => e.id === parseInt(empId));
      if (!emp) return;

      const daySchedule = state.schedule[day] || { lunch: [], dinner: [] };
      const assignedIds = [...daySchedule.lunch.map(e => e.id), ...daySchedule.dinner.map(e => e.id)];

      const availableEmployees = state.employees
        .filter(e => e.status === 'active' && !assignedIds.includes(e.id))
        .map(e => {
          const prefs = state.preferences[e.id]?.[day];
          let prefText = 'No preference';
          let prefColor = '#999';

          if (period === 'lunch' && prefs?.morning) {
            if (prefs.morning === 1) {
              prefText = 'ğŸŸ¡ Prefers Open';
              prefColor = '#FFD93D';
            } else if (prefs.morning === 2) {
              prefText = 'ğŸŸ¢ Prefers 11:00/11:30';
              prefColor = '#6BCB77';
            }
          } else if (period === 'dinner' && prefs?.evening) {
            if (prefs.evening === 1) {
              prefText = 'ğŸ”µ Prefers 3:30';
              prefColor = '#4D96FF';
            } else if (prefs.evening === 2) {
              prefText = 'ğŸŸ£ Prefers 6:00';
              prefColor = '#9D4EDD';
            }
          }

          return { emp: e, prefText, prefColor };
        });

      const t = TRANSLATIONS[state.language];
      const dayName = t.days?.[day] || day;
      const periodName = period === 'lunch' ? 'Lunch' : 'Dinner';

      const currentShift = period === 'lunch'
        ? daySchedule.lunch.find(e => e.id === emp.id)
        : daySchedule.dinner.find(e => e.id === emp.id);

      const swapHTML = `
        <div class="modal show" onclick="if(event.target === this) closeShiftModal()">
          <div class="modal-content" style="max-width:600px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
              <h3 style="margin:0;">Switch ${emp.name} - ${dayName} ${periodName}</h3>
              <button onclick="closeShiftModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">Ã—</button>
            </div>

            ${availableEmployees.length === 0 ? `
              <div style="padding:40px;text-align:center;background:#f9f9f9;border-radius:12px;">
                <p style="color:#666;">No available employees for swap</p>
                <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="margin-top:16px;">
                  â† Back
                </button>
              </div>
            ` : `
              <p style="margin-bottom:16px;color:#666;">Click an employee to swap:</p>
              <div style="max-height:400px;overflow-y:auto;">
                ${availableEmployees.map(({ emp: availEmp, prefText, prefColor }) => `
                  <div onclick="swapEmployee(${empId}, ${availEmp.id}, '${day}', '${period}', '${currentShift?.shift || ''}')" 
                       style="padding:14px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;
                              border-left:4px solid ${prefColor};cursor:pointer;
                              transition:background 0.2s;"
                       onmouseover="this.style.background='#e3f2fd'"
                       onmouseout="this.style.background='#f9f9f9'">
                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${availEmp.name}</div>
                    <div style="font-size:13px;color:#666;">${prefText}</div>
                  </div>
                `).join('')}
              </div>
              <button onclick="editShift(${empId}, '${day}', '${period}')" class="btn-secondary" style="width:100%;margin-top:16px;">
                â† Back
              </button>
            `}
          </div>
        </div>
      `;

      const existingModal = document.querySelector('.modal.show');
      if (existingModal) existingModal.remove();
      document.body.insertAdjacentHTML('beforeend', swapHTML);
    };

    // --- ì§ì› êµì²´ ---
    window.swapEmployee = async (removeEmpId, addEmpId, day, period, currentShift) => {
      const removeEmp = state.employees.find(e => e.id === parseInt(removeEmpId));
      const addEmp = state.employees.find(e => e.id === parseInt(addEmpId));
      if (!removeEmp || !addEmp) return;

      if (!state.schedule[day]) {
        state.schedule[day] = { lunch: [], dinner: [] };
      }

      const shifts = state.schedule[day][period];

      // Remove old employee
      const removeIndex = shifts.findIndex(e => e.id === removeEmp.id);
      if (removeIndex !== -1) {
        shifts.splice(removeIndex, 1);
      }

      // Add new employee (keep same shift if exists, otherwise use preference)
      let newShift = currentShift;
      if (!newShift) {
        // Use first available shift option
        newShift = period === 'lunch' ? 'Open~Break' : '3:30~Close';
      }

      shifts.push({
        name: addEmp.name,
        shift: newShift,
        id: addEmp.id,
        isFixed: false
      });

      await saveSchedule();
      closeShiftModal();
      render();
    };

    // --- ì‹œí”„íŠ¸ ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeShiftModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- ê°€ëŠ¥í•œ ì§ì› ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeAvailableModal = () => {
      const modal = document.querySelector('.modal.show');
      if (modal) modal.remove();
    };

    // --- ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeModal = () => {
      state.showModal = false;
      render();
    };

    // --- Requirements ì—…ë°ì´íŠ¸ ---
    window.updateRequirement = (day, period, shift, value) => {
      state.requirements[day][period][shift] = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- All Day Max ì—…ë°ì´íŠ¸ ---
    window.updateAllDayMax = (day, value) => {
      state.requirements[day].allDayMax = parseInt(value) || 0;
      saveRequirements();
      render();
    };

    // --- Holiday í† ê¸€ ---
    window.toggleHoliday = (day) => {
      state.requirements[day].isHoliday = !state.requirements[day].isHoliday;
      saveRequirements();
      render();
    };

    // --- Preference ìˆœí™˜ (0 â†’ 1 â†’ 2 â†’ 0) ---
    window.cyclePreference = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const current = state.preferences[empId][day][period] || 0;
      const newValue = (current + 1) % 3;
      state.preferences[empId][day][period] = newValue;
      
      // ìƒ‰ê¹”ì´ ë¹ˆì¹¸(0)ìœ¼ë¡œ ëŒì•„ê°€ë©´ Fixedë„ ìë™ìœ¼ë¡œ í•´ì œ
      if (newValue === 0) {
        state.preferences[empId][day][period + 'Fixed'] = false;
      }
      
      render();
    };

    // --- Fixed í† ê¸€ ---
    window.toggleFixed = (day, period) => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      if (!state.preferences[empId]) {
        state.preferences[empId] = {};
      }
      if (!state.preferences[empId][day]) {
        state.preferences[empId][day] = { morning: 0, evening: 0, morningFixed: false, eveningFixed: false };
      }
      
      const fixedKey = period + 'Fixed';
      state.preferences[empId][day][fixedKey] = !state.preferences[empId][day][fixedKey];
      
      render();
    };

    // --- Preferences ì €ì¥ ---
    window.saveCurrentPreferences = async () => {
      if (!state.selectedEmployee) return;
      
      const empId = state.selectedEmployee.id;
      const minGuarantee = parseInt(document.getElementById('min-guarantee').value) || 0;
      
      state.preferences[empId] = {
        ...state.preferences[empId],
        minGuarantee,
        savedAt: new Date().toISOString()
      };
      
      await savePreferences();
      alert('âœ… Saved!');
      render();
    };

    // ============================================
    // SCHEDULE GENERATION - ìŠ¤ì¼€ì¤„ ìƒì„± ì•Œê³ ë¦¬ì¦˜
    // ìˆ˜ì •: ìŠ¤ì¼€ì¤„ ë¡œì§ ë³€ê²½í•˜ë ¤ë©´ ì´ í•¨ìˆ˜!
    // ============================================
    window.runScheduleGeneration = async () => {
      state.generating = true;
      render();

      await new Promise(resolve => setTimeout(resolve, 500));

      const newSchedule = {};
      const activeEmployees = state.employees.filter(e => e.status === 'active');

      // Holidayì¸ ë‚ ë“¤ ì°¾ê¸°
      const holidayDays = DAYS.filter(day => state.requirements[day].isHoliday);

      // ì§ì›ë³„ ì‹œí”„íŠ¸ ì¹´ìš´íŠ¸ ì¶”ì 
      const employeeShiftCount = {};
      activeEmployees.forEach(emp => {
        employeeShiftCount[emp.id] = 0;
      });

      // ========================================
      // ë°°ì • í—¬í¼ í•¨ìˆ˜
      // ========================================
      
      // ëœë¤ ì„ê¸°
      const shuffle = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      };

      // Shift ìë™ ì„ íƒ (ìœ ë™ì„±)
      const getFlexibleShift = (prefValue, period, needs) => {
        if (period === 'morning') {
          // ğŸŸ¡ ë…¸ë€ìƒ‰ (Open ì„ í˜¸)
          if (prefValue === 1) {
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
          }
          // ğŸŸ¢ ì´ˆë¡ìƒ‰ (11ì‹œ ì„ í˜¸)
          else if (prefValue === 2) {
            if (needs.eleven > 0) return { shift: '11:00~Break', type: 'eleven' };
            if (needs.elevenThirty > 0) return { shift: '11:30~Break', type: 'elevenThirty' };
            if (needs.open > 0) return { shift: 'Open~Break', type: 'open' };
          }
        } else if (period === 'evening') {
          // ğŸ”µ íŒŒë€ìƒ‰ (3:30 ì„ í˜¸)
          if (prefValue === 1) {
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
          }
          // ğŸŸ£ ë³´ë¼ìƒ‰ (6ì‹œë§Œ)
          else if (prefValue === 2) {
            if (needs.six > 0) return { shift: '6:00~Close', type: 'six' };
            if (needs.threeThirty > 0) return { shift: '3:30~Close', type: 'threeThirty' };
          }
        }
        return null;
      };

      // ========================================
      // ê° ìš”ì¼ë³„ ìŠ¤ì¼€ì¤„ ìƒì„±
      // ========================================
      DAYS.forEach(day => {
        const req = state.requirements[day];
        const isHoliday = req.isHoliday;
        
        newSchedule[day] = {
          lunch: [],
          dinner: []
        };

        // Remaining needs (ë™ì ìœ¼ë¡œ ê°ì†Œ)
        const remainingNeeds = {
          lunch: {
            open: req.lunch.open || 0,
            eleven: req.lunch.eleven || 0,
            elevenThirty: req.lunch.elevenThirty || 0
          },
          dinner: {
            threeThirty: req.dinner.threeThirty || 0,
            six: req.dinner.six || 0
          }
        };

        const totalLunchNeed = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
        const totalDinnerNeed = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;

        // ì´ë¯¸ ë°°ì •ëœ ì§ì› ì¶”ì 
        const assignedEmployees = new Set();

        // ========================================
        // STEP 1: Fixed ì‹œí”„íŠ¸ ë°°ì • (ë¬´ì¡°ê±´!)
        // ========================================
        activeEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          if (!prefs) return;

          // Morning Fixed
          if (prefs.morning > 0 && prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening Fixed
          if (prefs.evening > 0 && prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: true 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 2: Min Guarantee ë¶€ì¡±í•œ ì‚¬ëŒ ìš°ì„ 
        // ========================================
        const empWithMinGuarantee = activeEmployees
          .filter(emp => {
            if (assignedEmployees.has(emp.id)) return false;
            const prefs = state.preferences[emp.id];
            const minGuarantee = prefs?.minGuarantee || 0;
            return minGuarantee > 0 && employeeShiftCount[emp.id] < minGuarantee;
          })
          .map(emp => ({
            emp,
            deficit: (state.preferences[emp.id]?.minGuarantee || 0) - employeeShiftCount[emp.id],
            prefs: state.preferences[emp.id]?.[day]
          }))
          .sort((a, b) => b.deficit - a.deficit); // ë¶€ì¡±í•œ ìˆœ

        empWithMinGuarantee.forEach(({ emp, prefs }) => {
          if (!prefs) return;

          // Morning (Fixed ì•„ë‹Œ ê²ƒë§Œ)
          if (prefs.morning > 0 && !prefs.morningFixed) {
            const total = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            if (total > 0) {
              const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
              if (result) {
                newSchedule[day].lunch.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.lunch[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }

          // Evening (Fixed ì•„ë‹Œ ê²ƒë§Œ)
          if (prefs.evening > 0 && !prefs.eveningFixed) {
            const total = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            if (total > 0) {
              const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
              if (result) {
                newSchedule[day].dinner.push({ 
                  name: emp.name, 
                  shift: result.shift, 
                  id: emp.id, 
                  isFixed: false 
                });
                remainingNeeds.dinner[result.type]--;
                employeeShiftCount[emp.id]++;
                assignedEmployees.add(emp.id);
              }
            }
          }
        });

        // ========================================
        // STEP 3: ëœë¤ ë°°ì • (Fixed ì—†ëŠ” ì‚¬ëŒ ìš°ì„ )
        // ========================================
        
        // Fixedê°€ í•˜ë‚˜ë„ ì—†ëŠ” ì‚¬ëŒ
        const noFixedEmployees = shuffle(activeEmployees.filter(emp => {
          if (assignedEmployees.has(emp.id)) return false;
          const allPrefs = state.preferences[emp.id];
          if (!allPrefs) return true;
          
          // ëª¨ë“  ë‚ ì§œ ì²´í¬í•´ì„œ Fixedê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì œì™¸
          const hasAnyFixed = DAYS.some(d => {
            const dayPref = allPrefs[d];
            return dayPref && (dayPref.morningFixed || dayPref.eveningFixed);
          });
          return !hasAnyFixed;
        }));

        // ëœë¤ ë°°ì • - Fixed ì—†ëŠ” ì‚¬ëŒ
        noFixedEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 4: ì—¬ì „íˆ ë¶€ì¡±í•˜ë©´ Fixed ìˆëŠ” ì‚¬ëŒë„ ëœë¤
        // ========================================
        const remainingEmployees = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));

        remainingEmployees.forEach(emp => {
          const prefs = state.preferences[emp.id]?.[day];
          
          // Morning
          const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
          if (lunchTotal > 0 && prefs?.morning > 0 && !prefs.morningFixed) {
            const result = getFlexibleShift(prefs.morning, 'morning', remainingNeeds.lunch);
            if (result) {
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }

          // Evening
          const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
          if (dinnerTotal > 0 && prefs?.evening > 0 && !prefs.eveningFixed) {
            const result = getFlexibleShift(prefs.evening, 'evening', remainingNeeds.dinner);
            if (result) {
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift: result.shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[result.type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          }
        });

        // ========================================
        // STEP 5: Holiday ì²˜ë¦¬
        // ========================================
        if (isHoliday) {
          const unassigned = shuffle(activeEmployees.filter(emp => !assignedEmployees.has(emp.id)));
          
          unassigned.forEach(emp => {
            const lunchTotal = remainingNeeds.lunch.open + remainingNeeds.lunch.eleven + remainingNeeds.lunch.elevenThirty;
            const dinnerTotal = remainingNeeds.dinner.threeThirty + remainingNeeds.dinner.six;
            
            if (lunchTotal > 0) {
              const shift = remainingNeeds.lunch.open > 0 ? 'Open~Break' : 
                           remainingNeeds.lunch.eleven > 0 ? '11:00~Break' : '11:30~Break';
              const type = remainingNeeds.lunch.open > 0 ? 'open' : 
                          remainingNeeds.lunch.eleven > 0 ? 'eleven' : 'elevenThirty';
              
              newSchedule[day].lunch.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.lunch[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            } else if (dinnerTotal > 0) {
              const shift = remainingNeeds.dinner.threeThirty > 0 ? '3:30~Close' : '6:00~Close';
              const type = remainingNeeds.dinner.threeThirty > 0 ? 'threeThirty' : 'six';
              
              newSchedule[day].dinner.push({ 
                name: emp.name, 
                shift, 
                id: emp.id, 
                isFixed: false 
              });
              remainingNeeds.dinner[type]--;
              employeeShiftCount[emp.id]++;
              assignedEmployees.add(emp.id);
            }
          });
        }
      });

      state.schedule = newSchedule;
      await saveSchedule();
      state.generating = false;
      render();
    };

    // ============================================
    // ì•± ì‹œì‘!
    // ============================================
    loadInitialData();
  </script>
</body>
</html>
